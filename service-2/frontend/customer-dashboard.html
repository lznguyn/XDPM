<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MuTraPro - B·∫£ng ƒêi·ªÅu Khi·ªÉn Kh√°ch H√†ng</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Header */
      .header {
        background: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        color: #333;
        font-size: 28px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-info {
        text-align: right;
      }

      .customer-name {
        font-size: 16px;
        color: #666;
        margin-bottom: 5px;
      }

      .logout-btn {
        background: #ff6b6b;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }

      .logout-btn:hover {
        background: #ff5252;
      }

      /* Notifications */
      .notification-container {
        position: relative;
        margin-right: 15px;
      }

      .notification-icon {
        position: relative;
        background: #f0f0f0;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.3s;
      }

      .notification-icon:hover {
        background: #e0e0e0;
      }

      .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff4444;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
      }

      .notification-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 10px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        width: 400px;
        max-height: 500px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }

      .notification-dropdown.show {
        display: block;
      }

      .notification-header {
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notification-header h3 {
        margin: 0;
        font-size: 16px;
        color: #333;
      }

      .notification-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
      }

      .notification-item:hover {
        background: #f8f8f8;
      }

      .notification-item.unread {
        background: #f0f7ff;
        font-weight: 500;
      }

      .notification-item-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .notification-item-message {
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
      }

      .notification-item-time {
        font-size: 11px;
        color: #999;
      }

      .notification-empty {
        padding: 40px 20px;
        text-align: center;
        color: #999;
      }

      /* Tabs Navigation */
      .tabs-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        background: white;
        padding: 10px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex-wrap: wrap;
      }

      .tab-button {
        padding: 12px 20px;
        border: none;
        background: #f0f0f0;
        color: #666;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
        white-space: nowrap;
      }

      .tab-button.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .tab-button:hover {
        background: #e0e0e0;
      }

      .tab-button.active:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      /* Tab Content */
      .tab-content {
        display: none;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: fadeIn 0.3s ease-in;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      /* Buttons */
      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #e0e0e0;
        color: #333;
      }

      .btn-secondary:hover {
        background: #d0d0d0;
      }

      .btn-danger {
        background: #ff6b6b;
        color: white;
      }

      .btn-danger:hover {
        background: #ff5252;
      }

      .btn-success {
        background: #51cf66;
        color: white;
      }

      .btn-success:hover {
        background: #40c057;
      }

      /* Cards */
      .card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s;
      }

      .card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e0e0e0;
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
      }

      .card-meta {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        font-size: 13px;
        color: #999;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge-pending {
        background: #fff3bf;
        color: #e67700;
      }

      .badge-processing {
        background: #d0ebff;
        color: #1971c2;
      }

      .badge-completed {
        background: #d3f9d8;
        color: #2f9e44;
      }

      .badge-paid {
        background: #d3f9d8;
        color: #2f9e44;
      }

      .badge-unpaid {
        background: #ffe0e6;
        color: #c92a2a;
      }

      /* Progress Bar */
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s;
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-number {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 14px;
        opacity: 0.9;
      }

      /* Table */
      .table-responsive {
        overflow-x: auto;
        margin-top: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
        color: #666;
        font-size: 14px;
      }

      tr:hover {
        background: #f9f9f9;
      }

      /* File Upload */
      .file-upload {
        border: 2px dashed #667eea;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #f8f9ff;
      }

      .file-upload:hover {
        border-color: #764ba2;
        background: #f0f1ff;
      }

      .file-upload.active {
        border-color: #764ba2;
        background: #f0f1ff;
      }

      .file-upload input[type="file"] {
        display: none;
      }

      .upload-icon {
        font-size: 40px;
        margin-bottom: 10px;
      }

      .upload-text {
        color: #667eea;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .upload-hint {
        color: #999;
        font-size: 12px;
      }

      /* Messages */
      .message {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        animation: slideIn 0.3s ease-out;
      }

      .message.success {
        background: #d3f9d8;
        color: #2f9e44;
        border-left: 4px solid #2f9e44;
      }

      .message.error {
        background: #ffe0e6;
        color: #c92a2a;
        border-left: 4px solid #c92a2a;
      }

      .message.info {
        background: #d0ebff;
        color: #1971c2;
        border-left: 4px solid #1971c2;
      }

      @keyframes slideIn {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e0e0e0;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        transition: color 0.3s;
      }

      .modal-close:hover {
        color: #333;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          text-align: center;
          gap: 15px;
        }

        .header-info {
          text-align: center;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .tabs-container {
          flex-direction: column;
        }

        .tab-button {
          width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .btn-success:hover {
            background: #40c057;
        }

        /* Cards */
        .card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .card-meta {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 13px;
            color: #999;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-pending {
            background: #fff3bf;
            color: #e67700;
        }

        .badge-processing {
            background: #d0ebff;
            color: #1971c2;
        }

        .badge-completed {
            background: #d3f9d8;
            color: #2f9e44;
        }

        .badge-success {
            background: #d3f9d8;
            color: #2f9e44;
        }

        .badge-paid {
            background: #d3f9d8;
            color: #2f9e44;
        }

        .badge-unpaid {
            background: #ffe0e6;
            color: #c92a2a;
        }

        .badge-cancelled {
            background: #ffe0e6;
            color: #dc2626;
        }

        .badge-canceled {
            background: #ffe0e6;
            color: #dc2626;
        }

        .badge-available {
            background: #d3f9d8;
            color: #2f9e44;
        }

        .badge-occupied {
            background: #ffe0e6;
            color: #c92a2a;
        }

        .badge-maintenance {
            background: #fff3bf;
            color: #e67700;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        /* Stats Grid */
        .stats-grid {
          grid-template-columns: 1fr;
        }

        .tab-content {
          padding: 15px;
        }
      }

      /* Loading Spinner */
      .spinner {
        border: 3px solid #f0f0f0;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 20px;
        color: #667eea;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>üéµ MuTraPro Dashboard</h1>
        <div class="header-info" style="display: flex; align-items: center; gap: 15px;">
          <!-- Notifications -->
          <div class="notification-container">
            <button class="notification-icon" onclick="toggleNotifications()" id="notificationBtn">
              üîî
              <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
            <div class="notification-dropdown" id="notificationDropdown">
              <div class="notification-header">
                <h3>Th√¥ng b√°o</h3>
                <button onclick="markAllAsRead()" style="background: none; border: none; color: #667eea; cursor: pointer; font-size: 12px;">
                  ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
                </button>
              </div>
              <div id="notificationList">
                <div class="notification-empty">ƒêang t·∫£i...</div>
              </div>
            </div>
          </div>
          <div class="customer-name" id="customerNameDisplay">Kh√°ch h√†ng</div>
          <button class="logout-btn" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
        </div>
      </div>

      <!-- Tabs Navigation -->
      <div class="tabs-container">
        <button class="tab-button active" onclick="switchTab('dashboard')">
          üìä B·∫£ng ƒêi·ªÅu Khi·ªÉn
        </button>
        <button class="tab-button" onclick="switchTab('profile')">
          üë§ H·ªì S∆° Kh√°ch H√†ng
        </button>
        <button class="tab-button" onclick="switchTab('upload')">
          üìÅ T·∫°o Y√™u C·∫ßu
        </button>
        <button class="tab-button" onclick="switchTab('tracking')">
          üìã Theo D√µi ƒê∆°n
        </button>
        <button class="tab-button" onclick="switchTab('payments')">
          üí∞ Thanh To√°n
        </button>
        <button class="tab-button" onclick="switchTab('feedback')">
          üí¨ Y√™u C·∫ßu Ch·ªânh S·ª≠a
        </button>
        <button class="tab-button" onclick="switchTab('studios')">
          üéôÔ∏è ƒê·∫∑t Studio
        </button>
        <button class="tab-button" onclick="window.location.href='index.html'">
          üè† Trang Ch·ªß
        </button>
      </div>

      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-content active">
        <h2>üìä T·ªïng Quan</h2>
        <div class="stats-grid" id="statsGrid"></div>
        <h3 style="margin-top: 30px; margin-bottom: 20px">ƒê∆°n H√†ng G·∫ßn ƒê√¢y</h3>
        <div id="recentRequests"></div>
      </div>

      <!-- Profile Tab -->
      <div id="profile" class="tab-content">
        <h2>üë§ Qu·∫£n L√Ω H·ªì S∆° Kh√°ch H√†ng</h2>
        <div id="profileMessage"></div>

        <div class="form-row">
          <div class="form-group">
            <label>T√™n Kh√°ch H√†ng *</label>
            <input
              type="text"
              id="profileName"
              placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n"
            />
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="profileEmail" placeholder="Nh·∫≠p email" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ƒêi·ªán Tho·∫°i</label>
            <input
              type="tel"
              id="profilePhone"
              placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
            />
          </div>
          <div class="form-group">
            <label>ƒê·ªãa Ch·ªâ</label>
            <input type="text" id="profileAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" />
          </div>
        </div>

        <div style="display: flex; gap: 10px">
          <button class="btn btn-primary" onclick="saveProfile()">
            üíæ L∆∞u H·ªì S∆°
          </button>
          <button class="btn btn-secondary" onclick="loadProfile()">
            üîÑ T·∫£i L·∫°i
          </button>
        </div>
      </div>

      <!-- Upload Tab -->
      <div id="upload" class="tab-content">
        <h2>üìÅ T·∫°o Y√™u C·∫ßu D·ªãch V·ª•</h2>
        <div id="uploadMessage"></div>

        <div class="form-group">
          <label>Lo·∫°i D·ªãch V·ª• *</label>
          <select id="serviceType">
            <option value="">-- Ch·ªçn Lo·∫°i D·ªãch V·ª• --</option>
            <option value="transcription">üé§ Phi√™n √Çm (Transcription)</option>
            <option value="arrangement">üéº Ph·ªëi kh√≠ (Arrangement)</option>
            <option value="recording">üéôÔ∏è Thu √Çm (Recording)</option>
          </select>
        </div>

        <div class="form-group">
          <label>T·ªáp √Çm Thanh / Nh·∫°c *</label>
          <div class="file-upload" id="fileUpload">
            <div class="upload-icon">üì§</div>
            <div class="upload-text">K√©o th·∫£ t·ªáp ho·∫∑c nh·∫•p ƒë·ªÉ ch·ªçn</div>
            <div class="upload-hint">
              H·ªó tr·ª£ MP3, WAV, OGG, FLAC (T·ªëi ƒëa 100MB)
            </div>
            <input type="file" id="audioFile" accept="audio/*" />
          </div>
        </div>

        <div class="form-group">
          <label>M√¥ T·∫£ Y√™u C·∫ßu</label>
          <textarea
            id="requestDescription"
            placeholder="M√¥ t·∫£ chi ti·∫øt y√™u c·∫ßu c·ªßa b·∫°n..."
          ></textarea>
        </div>

        <button
          class="btn btn-primary"
          onclick="submitRequest()"
          style="width: 100%; margin-top: 20px;"
        >
          üì§ G·ª≠i Y√™u C·∫ßu
        </button>
      </div>

      <!-- Tracking Tab -->
      <div id="tracking" class="tab-content">
        <h2>üìã Theo D√µi ƒê∆°n H√†ng</h2>
        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Hi·ªÉn th·ªã c√°c ƒë∆°n h√†ng ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω v√† ch∆∞a ho√†n th√†nh</p>
        <div id="trackingMessage"></div>
        <div id="requestsList"></div>
      </div>

      <!-- History Tab -->
      <div id="history" class="tab-content">
        <h2>üìö L·ªãch S·ª≠ ƒê∆°n H√†ng</h2>
        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Hi·ªÉn th·ªã c√°c ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh v√† ƒë√£ thanh to√°n, ho·∫∑c ƒë√£ b·ªã h·ªßy</p>
        <div id="historyMessage"></div>
        <div id="historyList"></div>
      </div>

      <!-- Payments Tab -->
      <div id="payments" class="tab-content">
        <h2>üí∞ Qu·∫£n L√Ω Thanh To√°n</h2>
        <div id="paymentsMessage"></div>

        <!-- Payment Stats -->
        <div class="stats-grid" id="paymentStats"></div>

        <!-- Unpaid Requests -->
        <h3 style="margin-top: 30px; margin-bottom: 20px">
          C√°c ƒê∆°n Ch∆∞a Thanh To√°n
        </h3>
        <div id="unpaidRequests"></div>

        <!-- Transactions -->
        <h3 style="margin-top: 30px; margin-bottom: 20px">L·ªãch S·ª≠ Giao D·ªãch</h3>
        <div class="table-responsive">
          <table id="transactionsTable">
            <thead>
              <tr>
                <th>Ng√†y Giao D·ªãch</th>
                <th>M√£ Thanh To√°n</th>
                <th>Li√™n K·∫øt ƒê∆°n</th>
                <th>S·ªë Ti·ªÅn</th>
                <th>Tr·∫°ng Th√°i</th>
              </tr>
            </thead>
            <tbody id="transactionsBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Studios Tab -->
      <div id="studios" class="tab-content">
        <h2>üéôÔ∏è ƒê·∫∑t Ph√≤ng Thu √Çm</h2>
        <div id="studiosMessage"></div>
        
        <!-- Studio List -->
        <div id="studiosList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
          <!-- Studios will be loaded here -->
        </div>

        <!-- Booking Modal -->
        <div id="bookingModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h2 class="modal-title">üìÖ ƒê·∫∑t Ph√≤ng Thu</h2>
              <button class="modal-close" onclick="closeBookingModal()">‚úï</button>
            </div>
            <div id="bookingModalBody">
              <!-- Booking form will be inserted here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Feedback Tab -->
      <div id="feedback" class="tab-content">
        <h2>üí¨ Y√™u C·∫ßu Ch·ªânh S·ª≠a & Ph·∫£n H·ªìi</h2>
        <div id="feedbackMessage"></div>

        <div class="form-group">
          <label>Ch·ªçn ƒê∆°n H√†ng *</label>
          <select id="feedbackRequestId">
            <option value="">-- Ch·ªçn ƒê∆°n H√†ng --</option>
          </select>
        </div>

        <div class="form-group">
          <label>N·ªôi Dung Ch·ªânh S·ª≠a / Ph·∫£n H·ªìi *</label>
          <textarea
            id="feedbackContent"
            placeholder="M√¥ t·∫£ chi ti·∫øt nh·ªØng ch·ªânh s·ª≠a b·∫°n mu·ªën..."
          ></textarea>
        </div>

        <div class="form-group">
          <label>Lo·∫°i Ph·∫£n H·ªìi *</label>
          <select id="feedbackType">
            <option value="">-- Ch·ªçn Lo·∫°i --</option>
            <option value="revision">‚úèÔ∏è Y√™u C·∫ßu Ch·ªânh S·ª≠a</option>
            <option value="bug">üêõ B√°o L·ªói</option>
            <option value="suggestion">üí° ƒê·ªÅ Xu·∫•t</option>
          </select>
        </div>

        <button
          class="btn btn-primary"
          onclick="submitFeedback()"
          style="width: 100%"
        >
          üì§ G·ª≠i Ph·∫£n H·ªìi
        </button>

        <!-- Previous Feedback -->
        <h3 style="margin-top: 30px; margin-bottom: 20px">Ph·∫£n H·ªìi Tr∆∞·ªõc ƒê√≥</h3>
        <div id="feedbackHistory"></div>
      </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">üí≥ Thanh To√°n</h2>
          <button class="modal-close" onclick="closePaymentModal()">‚úï</button>
        </div>
        <div id="paymentModalBody"></div>
      </div>
    </div>

    <!-- Select Expert Modal -->
    <div id="selectExpertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üë§ Ch·ªçn Chuy√™n Gia & Ng√†y G·∫∑p</h2>
                <button class="modal-close" onclick="closeSelectExpertModal()">‚úï</button>
            </div>
            <div id="selectExpertModalBody"></div>
        </div>
    </div>

    <script>
        // Configuration - Use Kong Gateway
        const API_BASE = 'http://localhost:8000';
        
        // ============================================================================
        // Timezone Helper Functions (UTC+7 - Vietnam Time)
        // ============================================================================
        /**
         * Format date theo timezone UTC+7 (Vietnam Time)
         * @param {string|Date} dateInput - Date string ho·∫∑c Date object
         * @param {string} format - Format type: 'date', 'datetime', 'time'
         * @returns {string} Formatted date string
         */
        function formatVietnamDate(dateInput, format = 'date') {
            if (!dateInput) return 'N/A';
            
            let date;
            if (dateInput instanceof Date) {
                date = dateInput;
            } else {
                // Parse date string (c√≥ th·ªÉ l√† UTC ho·∫∑c local)
                date = new Date(dateInput);
            }
            
            // Chuy·ªÉn ƒë·ªïi sang timezone UTC+7
            // JavaScript Date object lu√¥n l∆∞u tr·ªØ theo UTC, nh∆∞ng hi·ªÉn th·ªã theo local timezone
            // ƒê·ªÉ ƒë·∫£m b·∫£o hi·ªÉn th·ªã ƒë√∫ng UTC+7, ta c·∫ßn adjust offset
            const utcTime = date.getTime() + (date.getTimezoneOffset() * 60000);
            const vietnamTime = new Date(utcTime + (7 * 3600000)); // UTC+7 = +7 hours
            
            const options = {
                timeZone: 'Asia/Ho_Chi_Minh',
                ...(format === 'date' ? {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                } : format === 'datetime' ? {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                } : {
                    hour: '2-digit',
                    minute: '2-digit'
                })
            };
            
            try {
                return vietnamTime.toLocaleString('vi-VN', options);
            } catch (e) {
                // Fallback n·∫øu timezone kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£
                const year = vietnamTime.getFullYear();
                const month = String(vietnamTime.getMonth() + 1).padStart(2, '0');
                const day = String(vietnamTime.getDate()).padStart(2, '0');
                
                if (format === 'date') {
                    return `${day}/${month}/${year}`;
                } else if (format === 'datetime') {
                    const hours = String(vietnamTime.getHours()).padStart(2, '0');
                    const minutes = String(vietnamTime.getMinutes()).padStart(2, '0');
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }
                return `${day}/${month}/${year}`;
            }
        }
        
        /**
         * L·∫•y th·ªùi gian hi·ªán t·∫°i theo UTC+7
         */
        function getVietnamNow() {
            const now = new Date();
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
            return new Date(utcTime + (7 * 3600000));
        }
        
        // Cache ƒë·ªÉ l∆∞u gi√° d·ªãch v·ª•
        let servicePricesCache = {
            'Transcription': 50000,
            'Arrangement': 50000
        };

        // ==================== UTILITY: Load Service Prices ====================
        async function loadServicePrices() {
            try {
                const response = await fetch(`${API_BASE}/api/Admin/service-prices`);
                if (response.ok) {
                    const prices = await response.json();
                    // L∆∞u v√†o cache
                    if (Array.isArray(prices)) {
                        prices.forEach(price => {
                            const serviceType = price.serviceType || price.ServiceType;
                            if (serviceType && (serviceType === 'Transcription' || serviceType === 'Arrangement')) {
                                servicePricesCache[serviceType] = price.price || price.Price || 50000;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading service prices:', error);
                // Gi·ªØ gi√° m·∫∑c ƒë·ªãnh n·∫øu c√≥ l·ªói
            }
        }

        // Load service prices khi trang ƒë∆∞·ª£c load
        loadServicePrices();
        
        // Refresh gi√° m·ªói 5 ph√∫t
        setInterval(loadServicePrices, 5 * 60 * 1000);

        // ============================================================================
        // NOTIFICATIONS SYSTEM
        // ============================================================================
        let notifications = [];
        let notificationPollInterval = null;

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch(`${API_BASE}/api/Notification/customer/${currentCustomerId}`);
                if (response.ok) {
                    notifications = await response.json();
                    renderNotifications();
                    updateNotificationBadge();
                } else {
                    console.error('Error loading notifications:', response.status);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Get unread count
        async function getUnreadCount() {
            try {
                const response = await fetch(`${API_BASE}/api/Notification/customer/${currentCustomerId}/unread-count`);
                if (response.ok) {
                    const data = await response.json();
                    return data.count || 0;
                }
            } catch (error) {
                console.error('Error getting unread count:', error);
            }
            return 0;
        }

        // Render notifications
        function renderNotifications() {
            const list = document.getElementById('notificationList');
            if (!list) return;

            if (notifications.length === 0) {
                list.innerHTML = '<div class="notification-empty">Kh√¥ng c√≥ th√¥ng b√°o n√†o</div>';
                return;
            }

            list.innerHTML = notifications.map(notif => {
                const typeIcon = {
                    'Info': '‚ÑπÔ∏è',
                    'Success': '‚úÖ',
                    'Warning': '‚ö†Ô∏è',
                    'Error': '‚ùå',
                    'StatusChange': 'üîÑ'
                }[notif.type] || 'üì¢';

                return `
                    <div class="notification-item ${notif.isRead ? '' : 'unread'}" onclick="markAsRead(${notif.id})">
                        <div class="notification-item-title">${typeIcon} ${notif.title}</div>
                        <div class="notification-item-message">${notif.message}</div>
                        <div class="notification-item-time">${formatVietnamDate(notif.createdAt, 'datetime')}</div>
                    </div>
                `;
            }).join('');
        }

        // Update notification badge
        async function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;

            const count = await getUnreadCount();
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
                if (dropdown.classList.contains('show')) {
                    loadNotifications();
                }
            }
        }

        // Mark notification as read
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`${API_BASE}/api/Notification/${notificationId}/read`, {
                    method: 'PATCH'
                });
                if (response.ok) {
                    // Update local state
                    const notif = notifications.find(n => n.id === notificationId);
                    if (notif) {
                        notif.isRead = true;
                        renderNotifications();
                        updateNotificationBadge();
                    }
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Mark all as read
        async function markAllAsRead() {
            try {
                const response = await fetch(`${API_BASE}/api/Notification/customer/${currentCustomerId}/read-all`, {
                    method: 'PATCH'
                });
                if (response.ok) {
                    // Update local state
                    notifications.forEach(n => {
                        n.isRead = true;
                    });
                    renderNotifications();
                    updateNotificationBadge();
                }
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        }

        // Start polling for new notifications
        function startNotificationPolling() {
            // Load immediately
            loadNotifications();
            updateNotificationBadge();
            
            // Poll every 30 seconds
            notificationPollInterval = setInterval(() => {
                loadNotifications();
                updateNotificationBadge();
            }, 30000);
        }

        // Stop polling
        function stopNotificationPolling() {
            if (notificationPollInterval) {
                clearInterval(notificationPollInterval);
                notificationPollInterval = null;
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.querySelector('.notification-container');
            const dropdown = document.getElementById('notificationDropdown');
            if (container && dropdown && !container.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Get URL parameters (from service-1 login redirect)
        const urlParams = new URLSearchParams(window.location.search);
        const urlCustomerId = urlParams.get('customerId');
        const urlToken = urlParams.get('token');
        const urlName = urlParams.get('name');
        
        // Save URL parameters to localStorage if provided (from service-1 login)
        if (urlCustomerId) {
            localStorage.setItem('customerId', urlCustomerId);
            if (urlName) {
                localStorage.setItem('customerName', urlName);
            }
            if (urlToken) {
                localStorage.setItem('token', urlToken);
            }
            // Clean URL by removing parameters
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        let currentCustomerId = localStorage.getItem('customerId');
        let currentCustomerName = localStorage.getItem('customerName');

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        initializeApp();
      });

      function initializeApp() {
        if (!currentCustomerId) {
          // Redirect to auth page
          window.location.href = "auth.html";
        } else {
          updateCustomerDisplay();
          loadProfile();
          loadDashboard();
          startNotificationPolling();
        }
      }

      // ==================== LOGIN FLOW ====================
      function logout() {
        localStorage.removeItem("customerId");
        localStorage.removeItem("customerName");
        localStorage.removeItem("token");
        window.location.href = "auth.html";
      }

      function updateCustomerDisplay() {
        document.getElementById("customerNameDisplay").textContent =
          currentCustomerName || "Kh√°ch h√†ng";
      }

      // ==================== TAB SWITCHING ====================
      function switchTab(tabName, event) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });

        // Deactivate all buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });

        // Show selected tab
        const targetTab = document.getElementById(tabName);
        if (!targetTab) {
          console.error('Tab not found:', tabName);
          return;
        }
        targetTab.classList.add('active');

        // Activate selected button - find button by onclick attribute or use event
        if (event && event.target) {
          event.target.classList.add('active');
        } else {
          // Find button by looking for the one that calls switchTab with this tabName
          const buttons = document.querySelectorAll('.tab-button');
          buttons.forEach(btn => {
            const onclick = btn.getAttribute('onclick');
            if (onclick && onclick.includes(`switchTab('${tabName}')`) || onclick && onclick.includes(`switchTab("${tabName}")`)) {
              btn.classList.add('active');
            }
          });
        }

        // Load data for specific tabs
        if (tabName === 'dashboard') loadDashboard();
        if (tabName === 'tracking') loadRequests();
        if (tabName === 'history') loadHistory();
        if (tabName === 'payments') loadPayments();
        if (tabName === 'feedback') loadFeedback();
        if (tabName === 'studios') loadStudios();
      }

      // ==================== PROFILE MANAGEMENT ====================
      async function loadProfile() {
        try {
          const response = await fetch(
            `${API_BASE}/customers/${currentCustomerId}`
          );
          if (!response.ok) return;

          const customer = await response.json();
          document.getElementById("profileName").value = customer.name || "";
          document.getElementById("profileEmail").value = customer.email || "";
          document.getElementById("profilePhone").value = customer.phone || "";
          document.getElementById("profileAddress").value =
            customer.address || "";
        } catch (error) {
          console.error("Error loading profile:", error);
        }
      }

      async function saveProfile() {
        const name = document.getElementById("profileName").value.trim();
        const email = document.getElementById("profileEmail").value.trim();
        const phone = document.getElementById("profilePhone").value.trim();
        const address = document.getElementById("profileAddress").value.trim();
        const messageDiv = document.getElementById("profileMessage");

        if (!name || !email) {
          showMessage(messageDiv, "Vui l√≤ng nh·∫≠p t√™n v√† email", "error");
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE}/customers/${currentCustomerId}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, email, phone, address }),
            }
          );

          if (!response.ok) throw new Error("L·ªói c·∫≠p nh·∫≠t h·ªì s∆°");

          showMessage(messageDiv, "‚úì H·ªì s∆° ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng", "success");
          localStorage.setItem("customerName", name);
          updateCustomerDisplay();
        } catch (error) {
          showMessage(messageDiv, "L·ªói: " + error.message, "error");
        }
      }

      // ==================== FILE UPLOAD ====================
      const fileUpload = document.getElementById("fileUpload");
      const audioFileInput = document.getElementById("audioFile");

      fileUpload.addEventListener("click", () => audioFileInput.click());

      fileUpload.addEventListener("dragover", (e) => {
        e.preventDefault();
        fileUpload.classList.add("active");
      });

      fileUpload.addEventListener("dragleave", () => {
        fileUpload.classList.remove("active");
      });

      fileUpload.addEventListener("drop", (e) => {
        e.preventDefault();
        fileUpload.classList.remove("active");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          audioFileInput.files = files;
        }
      });

      audioFileInput.addEventListener("change", () => {
        const fileName = audioFileInput.files[0]?.name || "Ch·ªçn t·ªáp";
        fileUpload.querySelector(".upload-text").textContent = "‚úì " + fileName;
      });

      async function submitRequest() {
        const serviceType = document.getElementById("serviceType").value;
        const description = document
          .getElementById("requestDescription")
          .value.trim();
        const file = audioFileInput.files[0];
        const messageDiv = document.getElementById("uploadMessage");

        if (!serviceType || !file) {
          showMessage(messageDiv, "Vui l√≤ng ch·ªçn lo·∫°i d·ªãch v·ª• v√† t·ªáp", "error");
          return;
        }

        try {
          const formData = new FormData();
          formData.append("customer_id", currentCustomerId);
          formData.append("service_type", serviceType);
          formData.append(
            "title",
            `${serviceType.toUpperCase()} - ${formatVietnamDate(getVietnamNow())}`
          );
          formData.append("status", "pending"); // ƒê·∫∑t tr·∫°ng th√°i m·∫∑c ƒë·ªãnh l√† pending
          formData.append("file", file);
          if (description) formData.append("description", description);

          messageDiv.innerHTML =
            '<div class="loading"><div class="spinner"></div> ƒêang t·∫£i l√™n...</div>';

          const response = await fetch(`${API_BASE}/requests`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) throw new Error("L·ªói g·ª≠i y√™u c·∫ßu");

          const request = await response.json();
          showMessage(
            messageDiv,
            `‚úì Y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng (ID: ${request.id.substring(
              0,
              8
            )})`,
            "success"
          );

          // Reset form
          document.getElementById("serviceType").value = "";
          document.getElementById("requestDescription").value = "";
          audioFileInput.value = "";
          fileUpload.querySelector(".upload-text").textContent =
            "K√©o th·∫£ t·ªáp ho·∫∑c nh·∫•p ƒë·ªÉ ch·ªçn";

          // Reload requests and dashboard
          setTimeout(() => {
            loadRequests();
            loadDashboard();
          }, 2000);
        } catch (error) {
          showMessage(messageDiv, "L·ªói: " + error.message, "error");
        }
      }
      // ==================== STUDIO BOOKING ====================
      async function loadStudios() {
        const select = document.getElementById("studioSelect");
        const msg = document.getElementById("studioMessage");
        select.innerHTML =
          '<option value="">-- ƒêang t·∫£i danh s√°ch studio... --</option>';
        try {
          const res = await fetch(`${API_BASE}/api/Studio`);
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch studio");
          const studios = await res.json();
          if (!Array.isArray(studios) || studios.length === 0) {
            select.innerHTML =
              '<option value="">-- Kh√¥ng c√≥ studio --</option>';
            return;
          }
          select.innerHTML =
            '<option value="">-- Ch·ªçn Studio --</option>' +
            studios
              .map(
                (s) =>
                  `<option value="${s.id}">${s.name} ‚Äî ${
                    s.location || ""
                  }</option>`
              )
              .join("");
        } catch (err) {
          showMessage(msg, "L·ªói t·∫£i studio: " + err.message, "error");
          select.innerHTML = '<option value="">-- L·ªói khi t·∫£i --</option>';
        }
      }
      // studio file upload handlers (simple copy of existing upload behaviour)
      const studioFileUpload = document.getElementById("studioFileUpload");
      const studioAudioFile = document.getElementById("studioAudioFile");
      if (studioFileUpload && studioAudioFile) {
        studioFileUpload.addEventListener("click", () =>
          studioAudioFile.click()
        );
        studioFileUpload.addEventListener("dragover", (e) => {
          e.preventDefault();
          studioFileUpload.classList.add("active");
        });
        studioFileUpload.addEventListener("dragleave", () =>
          studioFileUpload.classList.remove("active")
        );
        studioFileUpload.addEventListener("drop", (e) => {
          e.preventDefault();
          studioFileUpload.classList.remove("active");
          const files = e.dataTransfer.files;
          if (files.length > 0) studioAudioFile.files = files;
        });
        studioAudioFile.addEventListener("change", () => {
          const fileName = studioAudioFile.files[0]?.name || "Ch·ªçn t·ªáp";
          studioFileUpload.querySelector(".upload-text").textContent =
            "‚úì " + fileName;
        });
      }
      async function submitStudioOrder() {
        const msg = document.getElementById("studioMessage");
        const studioId = document.getElementById("studioSelect").value;
        const serviceType = document.getElementById("studioServiceType").value;
        const date = document.getElementById("studioDate").value;
        const time = document.getElementById("studioTime").value;
        const notes = document.getElementById("studioNotes").value.trim();
        const file = document.getElementById("studioAudioFile").files[0];

        if (!studioId || !serviceType) {
          showMessage(msg, "Vui l√≤ng ch·ªçn studio v√† lo·∫°i d·ªãch v·ª•", "error");
          return;
        }

        try {
          const formData = new FormData();
          formData.append("customer_id", currentCustomerId);
          formData.append("studio_id", studioId);
          formData.append("service_type", serviceType);
          if (date) formData.append("date", date);
          if (time) formData.append("time", time);
          if (notes) formData.append("notes", notes);
          if (file) formData.append("file", file);

          msg.innerHTML =
            '<div class="loading"><div class="spinner"></div> ƒêang g·ª≠i ƒë·∫∑t l·ªãch...</div>';

          // Reuse requests endpoint and attach studio_id; backend should accept this.
          const res = await fetch(`${API_BASE}/requests`, {
            method: "POST",
            body: formData,
          });

          if (!res.ok) throw new Error("L·ªói t·∫°o ƒë∆°n ƒë·∫∑t studio");
          const created = await res.json();
          showMessage(
            msg,
            `‚úì ƒê·∫∑t studio th√†nh c√¥ng (ID: ${
              created.id?.substring(0, 8) || created.id
            })`,
            "success"
          );

          // reset form
          document.getElementById("studioSelect").value = "";
          document.getElementById("studioServiceType").value = "";
          document.getElementById("studioDate").value = "";
          document.getElementById("studioTime").value = "";
          document.getElementById("studioNotes").value = "";
          if (studioAudioFile) {
            studioAudioFile.value = "";
            studioFileUpload.querySelector(".upload-text").textContent =
              "K√©o th·∫£ t·ªáp ho·∫∑c nh·∫•p ƒë·ªÉ ch·ªçn";
          }

          // refresh lists
          setTimeout(() => {
            loadRequests();
            loadDashboard();
          }, 1000);
        } catch (err) {
          showMessage(msg, "L·ªói: " + err.message, "error");
        }
      }
      // ==================== DASHBOARD ====================
      async function loadDashboard() {
        try {
          const requestsResponse = await fetch(
            `${API_BASE}/requests/customer/${currentCustomerId}`
          );
          const requests = (await requestsResponse.ok)
            ? await requestsResponse.json()
            : [];

          // Calculate stats - lo·∫°i b·ªè ƒë∆°n b·ªã h·ªßy
          const validRequests = requests.filter(r => !isRequestCancelled(r));
          const stats = {
            total: validRequests.length,
            completed: validRequests.filter((r) => {
              const s = (r.status || '').toLowerCase();
              return s === 'completed' || s === 'finished';
            }).length,
            processing: validRequests.filter((r) => {
              const s = (r.status || '').toLowerCase();
              return s === 'pendingreview' || s === 'pending_review' || 
                     s === 'pendingmeetingconfirmation' || s === 'pending_meeting_confirmation' ||
                     s === 'processing' || s === 'inprogress' || s === 'in_progress';
            }).length,
            pending: validRequests.filter((r) => {
              const s = (r.status || '').toLowerCase();
              return s === 'requested' || s === 'pending' || s === 'submitted';
            }).length,
          };

          // Display stats
          const statsGrid = document.getElementById("statsGrid");
          statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label">T·ªïng ƒê∆°n H√†ng</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.pending}</div>
                        <div class="stat-label">Ch∆∞a X·ª≠ L√Ω</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.processing}</div>
                        <div class="stat-label">ƒêang X·ª≠ L√Ω</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.completed}</div>
                        <div class="stat-label">Ho√†n Th√†nh</div>
                    </div>
                `;

          // Display recent requests - lo·∫°i b·ªè ƒë∆°n b·ªã h·ªßy
          const recentRequests = document.getElementById("recentRequests");
          const recentValidRequests = validRequests.filter(r => !isRequestCancelled(r));
          if (recentValidRequests.length === 0) {
            recentRequests.innerHTML =
              '<p style="text-align: center; color: #999; padding: 20px;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>';
          } else {
            recentRequests.innerHTML = recentValidRequests
              .slice(0, 5)
              .map(
                (req) => `
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">${req.service_type.toUpperCase()}</div>
                                    <div class="card-meta">
                                        <span>ID: ${req.id.substring(
                                          0,
                                          8
                                        )}</span>
                                        <span>${formatVietnamDate(req.created_at)}</span>
                                    </div>
                                </div>
                                <span class="badge badge-${
                                  req.status
                                }">${translateStatus(req.status)}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${getProgressWidth(
                                  req.status
                                )}%"></div>
                            </div>
                        </div>
                    `
              )
              .join("");
          }
        } catch (error) {
          console.error("Error loading dashboard:", error);
        }
      }

        // ==================== REQUEST TRACKING ====================
        async function loadRequests() {
            try {
                const response = await fetch(`${API_BASE}/requests/customer/${currentCustomerId}`);
                const allRequests = await response.ok ? await response.json() : [];

                // L·ªçc ch·ªâ hi·ªÉn th·ªã ƒë∆°n ch∆∞a ho√†n th√†nh, ch∆∞a thanh to√°n, v√† ch∆∞a b·ªã h·ªßy
                const requests = allRequests.filter(req => {
                    const status = (req.status || req.Status || '').toLowerCase();
                    const paid = isRequestPaid(req);
                    const completed = status === 'completed' || status === 'finished';
                    const cancelled = isRequestCancelled(req);
                    
                    // Lo·∫°i b·ªè ƒë∆°n ƒë√£ ho√†n th√†nh v√† ƒë√£ thanh to√°n, ho·∫∑c ƒë∆°n ƒë√£ b·ªã h·ªßy
                    // Ch·ªâ hi·ªÉn th·ªã ƒë∆°n ƒëang x·ª≠ l√Ω (ch∆∞a ho√†n th√†nh ho·∫∑c ch∆∞a thanh to√°n) v√† ch∆∞a b·ªã h·ªßy
                    return !(completed && paid) && !cancelled;
                });

          const messageDiv = document.getElementById("trackingMessage");
          const requestsList = document.getElementById("requestsList");

                if (requests.length === 0) {
                    requestsList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒëang x·ª≠ l√Ω</p>';
                    return;
                }

                requestsList.innerHTML = requests.map(req => {
                    const serviceType = req.service_type || req.serviceType || '';
                    const status = req.status || req.Status || 'pending';
                    const paid = isRequestPaid(req);
                    return `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    ${getServiceIcon(serviceType)} ${serviceType.toUpperCase()}
                                </div>
                                <div class="card-meta">
                                    <span>ID: ${req.id}</span>
                                    <span>T·∫°o: ${formatVietnamDate(req.created_date || req.created_at || req.CreatedDate)}</span>
                                    ${req.title ? `<span>üìù ${req.title}</span>` : ''}
                                </div>
                            </div>
                            <span class="badge badge-${status.toLowerCase()}">${translateStatus(status)}</span>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${getProgressWidth(status)}%"></div>
                        </div>
                        
                        ${req.description ? `<p style="margin-top: 10px; color: #666; font-size: 14px;">üìù ${(req.description || '').substring(0, 100)}${(req.description || '').length > 100 ? '...' : ''}</p>` : ''}
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="viewRequestDetails('${req.id}')">Xem Chi Ti·∫øt</button>
                            ${status.toLowerCase() === 'pendingreview' || status.toLowerCase() === 'pending_review' ? `<button class="btn btn-primary" onclick="openSelectExpertModal('${req.id}')">üë§ Ch·ªçn Chuy√™n Gia</button>` : ''}
                            ${status.toLowerCase() === 'pending' || status.toLowerCase() === 'submitted' || status.toLowerCase() === 'requested' ? `<button class="btn btn-danger" onclick="cancelRequest('${req.id}')">H·ªßy Y√™u C·∫ßu</button>` : ''}
                            ${!paid && !isRequestCancelled(req) && (status.toLowerCase() === 'completed' || status.toLowerCase() === 'finished') ? `<button class="btn btn-primary" onclick="openPaymentModal('${req.id}')">üí≥ Thanh To√°n</button>` : ''}
                        </div>
                    </div>
                `;
                }).join('');
            } catch (error) {
                console.error('Error loading requests:', error);
                const requestsList = document.getElementById('requestsList');
                if (requestsList) {
                    requestsList.innerHTML = '<p style="text-align: center; color: #dc2626; padding: 20px;">‚ùå L·ªói t·∫£i danh s√°ch ƒë∆°n h√†ng</p>';
                }
            }
        }

        // ==================== HISTORY (Completed & Paid Orders) ====================
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/requests/customer/${currentCustomerId}`);
                const allRequests = await response.ok ? await response.json() : [];

                // L·ªçc ch·ªâ hi·ªÉn th·ªã ƒë∆°n ƒë√£ ho√†n th√†nh v√† ƒë√£ thanh to√°n HO·∫∂C ƒë∆°n ƒë√£ b·ªã h·ªßy
                const history = allRequests.filter(req => {
                    const status = (req.status || req.Status || '').toLowerCase();
                    const paid = isRequestPaid(req);
                    const completed = status === 'completed' || status === 'finished';
                    const cancelled = status === 'cancelled' || status === 'canceled';
                    
                    // Hi·ªÉn th·ªã n·∫øu ƒë√£ ho√†n th√†nh V√Ä ƒë√£ thanh to√°n, ho·∫∑c ƒë∆°n ƒë√£ b·ªã h·ªßy
                    return (completed && paid) || cancelled;
                });

                // S·∫Øp x·∫øp theo ng√†y ho√†n th√†nh (m·ªõi nh·∫•t tr∆∞·ªõc)
                history.sort((a, b) => {
                    const dateA = new Date(a.created_date || a.created_at || a.CreatedDate || 0);
                    const dateB = new Date(b.created_date || b.created_at || b.CreatedDate || 0);
                    return dateB - dateA;
                });

                const messageDiv = document.getElementById('historyMessage');
                const historyList = document.getElementById('historyList');

                if (history.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o trong l·ªãch s·ª≠</p>';
                    return;
                }

                historyList.innerHTML = history.map(req => {
                    const serviceType = req.service_type || req.serviceType || '';
                    const status = req.status || req.Status || 'completed';
                    const statusLower = (status || '').toLowerCase();
                    const paid = isRequestPaid(req);
                    const cancelled = statusLower === 'cancelled' || statusLower === 'canceled';
                    const completed = statusLower === 'completed' || statusLower === 'finished';
                    const price = extractStudioPrice(req);
                    
                    // Style kh√°c nhau cho ƒë∆°n h·ªßy v√† ƒë∆°n ho√†n th√†nh
                    const borderColor = cancelled ? '#dc2626' : '#10b981';
                    const cardBg = cancelled ? '#fef2f2' : '#f9fafb';
                    
                    return `
                    <div class="card" style="background: ${cardBg}; border-left: 4px solid ${borderColor};">
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    ${getServiceIcon(serviceType)} ${serviceType.toUpperCase()}
                                    ${req.title ? ` - ${req.title}` : ''}
                                </div>
                                <div class="card-meta">
                                    <span>ID: ${req.id}</span>
                                    <span>üìÖ ${formatVietnamDate(req.created_date || req.created_at || req.CreatedDate)}</span>
                                    ${req.due_date || req.dueDate || req.DueDate ? `<span>‚è∞ H·∫°n: ${formatVietnamDate(req.due_date || req.dueDate || req.DueDate)}</span>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px; align-items: flex-end;">
                                ${cancelled ? 
                                    `<span class="badge badge-cancelled">‚ùå ƒê√£ H·ªßy</span>` :
                                    `<span class="badge badge-success">‚úÖ Ho√†n Th√†nh</span>
                                     <span class="badge badge-success">üí≥ ƒê√£ Thanh To√°n</span>`
                                }
                            </div>
                        </div>
                        
                        ${req.description ? `<p style="margin-top: 10px; color: #666; font-size: 14px;">üìù ${(req.description || '').substring(0, 100)}${(req.description || '').length > 100 ? '...' : ''}</p>` : ''}
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                ${!cancelled ? 
                                    `<div style="font-size: 18px; font-weight: bold; color: #10b981;">
                                        üí∞ ${new Intl.NumberFormat('vi-VN').format(price)} ‚Ç´
                                    </div>` :
                                    `<div style="font-size: 14px; color: #666; font-style: italic;">
                                        ƒê∆°n h√†ng n√†y ƒë√£ b·ªã h·ªßy
                                    </div>`
                                }
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-secondary" onclick="viewRequestDetails('${req.id}')">Xem Chi Ti·∫øt</button>
                                    ${!cancelled && (req.file_name || req.fileName || req.FileName) ? `<a href="${API_BASE}/requests/${req.id}/download" target="_blank" class="btn btn-primary">üì• T·∫£i File</a>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading history:', error);
                const historyList = document.getElementById('historyList');
                if (historyList) {
                    historyList.innerHTML = '<p style="text-align: center; color: #dc2626; padding: 20px;">‚ùå L·ªói t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng</p>';
                }
            }
        }

      async function viewRequestDetails(requestId) {
        try {
          const response = await fetch(`${API_BASE}/requests/${requestId}`);
          const request = await response.json();
          alert(
            `Chi ti·∫øt ƒë∆°n h√†ng:\n\nID: ${request.id}\nLo·∫°i: ${
              request.service_type
            }\nTr·∫°ng th√°i: ${translateStatus(request.status)}\nT·∫°o: ${formatVietnamDate(
              request.created_at
            )}`
          );
        } catch (error) {
          alert("L·ªói: " + error.message);
        }
      }

        async function cancelRequest(requestId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy y√™u c·∫ßu n√†y?')) return;
            try {
                // Backend y√™u c·∫ßu Form data, kh√¥ng ph·∫£i JSON
                const formData = new URLSearchParams();
                formData.append('status', 'cancelled');
                
                const response = await fetch(`${API_BASE}/requests/${requestId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString()
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'L·ªói h·ªßy y√™u c·∫ßu' }));
                    throw new Error(errorData.detail || 'L·ªói h·ªßy y√™u c·∫ßu');
                }
                
                alert('‚úÖ ƒê√£ h·ªßy y√™u c·∫ßu th√†nh c√¥ng!');
                loadRequests();
                loadDashboard(); // Refresh dashboard stats
            } catch (error) {
                console.error('Error canceling request:', error);
                alert('L·ªói: ' + error.message);
            }
        }

        // ==================== SELECT EXPERT & SCHEDULE ====================
        let currentSelectExpertRequestId = null;

        async function openSelectExpertModal(requestId) {
            currentSelectExpertRequestId = requestId;
            const modal = document.getElementById('selectExpertModal');
            const modalBody = document.getElementById('selectExpertModalBody');
            
            try {
                // Load request details
                const requestResponse = await fetch(`${API_BASE}/requests/${requestId}`);
                if (!requestResponse.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin y√™u c·∫ßu');
                const request = await requestResponse.json();
                
                // Load experts (specialists) - need to get from service-1
                const expertsResponse = await fetch(`${API_BASE}/api/Admin/users`);
                if (!expertsResponse.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch chuy√™n gia');
                const allUsers = await expertsResponse.json();
                
                // Filter experts (Arrangement, Transcription, Recorder, Coordinator)
                const expertRoles = ['Arrangement', 'Transcription', 'Recorder', 'Coordinator'];
                const experts = allUsers.filter(u => expertRoles.includes(u.role || u.Role));
                
                // Filter by service type if possible
                const serviceType = request.service_type || request.serviceType || '';
                let suitableExperts = experts;
                if (serviceType) {
                    const normalizedType = serviceType.charAt(0).toUpperCase() + serviceType.slice(1).toLowerCase();
                    suitableExperts = experts.filter(e => {
                        const role = e.role || e.Role || '';
                        if (normalizedType === 'Transcription' && role === 'Transcription') return true;
                        if (normalizedType === 'Arrangement' && role === 'Arrangement') return true;
                        if (normalizedType === 'Recording' && role === 'Recorder') return true;
                        if (role === 'Coordinator') return true;
                        return false;
                    });
                    if (suitableExperts.length === 0) suitableExperts = experts; // Fallback to all experts
                }
                
                modalBody.innerHTML = `
                    <div style="padding: 20px;">
                        <div class="form-group">
                            <label>Ch·ªçn Chuy√™n Gia *</label>
                            <select id="expertSelect" required>
                                <option value="">-- Ch·ªçn Chuy√™n Gia --</option>
                                ${suitableExperts.map(e => `
                                    <option value="${e.id || e.Id}">${e.name || e.Name} (${e.role || e.Role})</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Ng√†y G·∫∑p *</label>
                            <input type="date" id="scheduleDate" required min="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <div class="form-group">
                            <label>Khung Gi·ªù *</label>
                            <select id="scheduleTimeSlot" required>
                                <option value="">-- Ch·ªçn Khung Gi·ªù --</option>
                                <option value="0-4">Ca 1: 0h - 4h</option>
                                <option value="6-10">Ca 2: 6h - 10h</option>
                                <option value="12-16">Ca 3: 12h - 16h</option>
                                <option value="18-22">Ca 4: 18h - 22h</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Ghi Ch√∫ (T√πy ch·ªçn)</label>
                            <textarea id="meetingNotes" placeholder="Ghi ch√∫ th√™m v·ªÅ cu·ªôc g·∫∑p..."></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="submitExpertSelection()" style="flex: 1;">‚úÖ X√°c Nh·∫≠n</button>
                            <button class="btn btn-secondary" onclick="closeSelectExpertModal()" style="flex: 1;">‚ùå H·ªßy</button>
                        </div>
                    </div>
                `;
                
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error opening select expert modal:', error);
                alert('L·ªói: ' + error.message);
            }
        }

        function closeSelectExpertModal() {
            const modal = document.getElementById('selectExpertModal');
            modal.style.display = 'none';
            currentSelectExpertRequestId = null;
        }

        async function submitExpertSelection() {
            if (!currentSelectExpertRequestId) return;
            
            const expertId = document.getElementById('expertSelect').value;
            const scheduleDate = document.getElementById('scheduleDate').value;
            const timeSlot = document.getElementById('scheduleTimeSlot').value;
            const meetingNotes = document.getElementById('meetingNotes').value;
            
            if (!expertId || !scheduleDate || !timeSlot) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/Customer/requests/${currentSelectExpertRequestId}/select-expert`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        specialistId: parseInt(expertId),
                        scheduledDate: scheduleDate,
                        timeSlot: timeSlot,
                        meetingNotes: meetingNotes || null
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'L·ªói ch·ªçn chuy√™n gia' }));
                    throw new Error(errorData.message || errorData.detail || 'L·ªói ch·ªçn chuy√™n gia');
                }
                
                const result = await response.json();
                alert('‚úÖ ' + (result.message || 'ƒê√£ ch·ªçn chuy√™n gia th√†nh c√¥ng!'));
                closeSelectExpertModal();
                loadRequests();
                loadDashboard();
            } catch (error) {
                console.error('Error submitting expert selection:', error);
                alert('L·ªói: ' + error.message);
            }
        }

        // ==================== UTILITY: Extract Service Price ====================
        function extractStudioPrice(request) {
            if (!request) return 50000;
            
            // N·∫øu request c√≥ description ch·ª©a STUDIO_BOOKING tag (Recording service)
            if (request.description) {
                const match = request.description.match(/\[STUDIO_BOOKING\](.*?)\[\/STUDIO_BOOKING\]/);
                if (match) {
                    try {
                        const bookingInfo = JSON.parse(match[1]);
                        if (bookingInfo.price !== undefined && bookingInfo.price !== null) {
                            // Convert price: c√≥ th·ªÉ l√† s·ªë ho·∫∑c string
                            const price = typeof bookingInfo.price === 'string' 
                                ? parseFloat(bookingInfo.price) 
                                : bookingInfo.price;
                            return isNaN(price) || price <= 0 ? 50000 : price;
                        }
                    } catch (e) {
                        console.error('Error parsing studio booking info:', e);
                    }
                }
            }
            
            // L·∫•y gi√° t·ª´ cache d·ª±a tr√™n service type (Transcription, Arrangement)
            const serviceType = request.service_type || request.serviceType || '';
            if (serviceType) {
                const normalizedType = serviceType.charAt(0).toUpperCase() + serviceType.slice(1).toLowerCase();
                
                // Recording: gi√° t·ª´ studio booking (ƒë√£ x·ª≠ l√Ω ·ªü tr√™n)
                if (normalizedType === 'Recording') {
                    return 50000; // Fallback n·∫øu kh√¥ng c√≥ studio booking info
                }
                
                // Transcription ho·∫∑c Arrangement: l·∫•y t·ª´ cache
                if (normalizedType === 'Transcription' || normalizedType === 'Arrangement') {
                    return servicePricesCache[normalizedType] || 50000;
                }
            }
            
            // Default price
            return 50000;
        }

        // ==================== PAYMENTS ====================
        async function loadPayments() {
            try {
                // Fetch fresh data t·ª´ server
                const requestsResponse = await fetch(`${API_BASE}/requests/customer/${currentCustomerId}?t=${Date.now()}`);
                const requests = await requestsResponse.ok ? await requestsResponse.json() : [];

                // Payment stats - ƒë·∫øm t·ª´ field 'paid' th·ª±c t·∫ø, lo·∫°i b·ªè ƒë∆°n b·ªã h·ªßy
                const validRequests = requests.filter(r => !isRequestCancelled(r));
                const unpaidCount = validRequests.filter(r => !isRequestPaid(r)).length;
                const paidCount = validRequests.filter(r => isRequestPaid(r)).length;
                const totalUnpaid = validRequests.filter(r => !isRequestPaid(r)).reduce((sum, r) => sum + extractStudioPrice(r), 0);
                const totalPaid = validRequests.filter(r => isRequestPaid(r)).reduce((sum, r) => sum + extractStudioPrice(r), 0);

          const paymentStats = document.getElementById("paymentStats");
          paymentStats.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${unpaidCount}</div>
                        <div class="stat-label">Ch∆∞a Thanh To√°n</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${(totalUnpaid / 1000).toFixed(
                          0
                        )}K</div>
                        <div class="stat-label">T·ªïng N·ª£</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${paidCount}</div>
                        <div class="stat-label">ƒê√£ Thanh To√°n</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${(totalPaid / 1000).toFixed(
                          0
                        )}K</div>
                        <div class="stat-label">T·ªïng ƒê√£ Tr·∫£</div>
                    </div>
                `;

                // Unpaid requests - refresh cache, lo·∫°i b·ªè ƒë∆°n b·ªã h·ªßy
                const unpaidRequests = document.getElementById('unpaidRequests');
                const unpaid = requests.filter(r => !isRequestPaid(r) && !isRequestCancelled(r));
                unpaidRequests.innerHTML = unpaid.length === 0 ? 
                    '<p style="text-align: center; color: #999; padding: 20px;">‚úÖ Kh√¥ng c√≥ ƒë∆°n ch∆∞a thanh to√°n - T·∫•t c·∫£ ƒë√£ thanh to√°n!</p>' :
                    unpaid.map(req => `
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">${getServiceIcon(
                                      req.service_type
                                    )} ${req.service_type.toUpperCase()}</div>
                                    <div class="card-meta">
                                        <span>ID: ${req.id.substring(
                                          0,
                                          8
                                        )}</span>
                                        <span>Tr·∫°ng th√°i: ${translateStatus(
                                          req.status
                                        )}</span>
                                    </div>
                                </div>
                                <span class="badge badge-unpaid">Ch∆∞a Thanh To√°n</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                <div style="font-size: 18px; font-weight: bold; color: #667eea;">${new Intl.NumberFormat('vi-VN').format(extractStudioPrice(req))} ‚Ç´</div>
                                <button class="btn btn-primary" onclick="openPaymentModal('${req.id}')">üí≥ Thanh To√°n Ngay</button>
                            </div>
                        </div>
                    `
                  )
                  .join("");

                // Show paid requests
                const paidRequests = requests.filter(r => isRequestPaid(r));
                if (paidRequests.length > 0) {
                    const paidSection = document.getElementById('unpaidRequests').parentElement;
                    let paidHTML = '<h3 style="margin-top: 30px; margin-bottom: 20px;">‚úÖ C√°c ƒê∆°n ƒê√£ Thanh To√°n</h3>';
                    paidHTML += paidRequests.map(req => `
                        <div class="card" style="opacity: 0.8;">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">${getServiceIcon(
                                      req.service_type
                                    )} ${req.service_type.toUpperCase()}</div>
                                    <div class="card-meta">
                                        <span>ID: ${req.id.substring(
                                          0,
                                          8
                                        )}</span>
                                        <span>Tr·∫°ng th√°i: ${translateStatus(
                                          req.status
                                        )}</span>
                                    </div>
                                </div>
                                <span class="badge" style="background:#4caf50; color:white;">ƒê√£ Thanh To√°n</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                <div style="font-size: 18px; font-weight: bold; color: #4caf50;">${new Intl.NumberFormat('vi-VN').format(extractStudioPrice(req))} ‚Ç´</div>
                                <span style="color:#999; font-size:13px;">Thanh to√°n th√†nh c√¥ng</span>
                            </div>
                        </div>
                    `
              )
              .join("");
            paidSection.innerHTML += paidHTML;
          }

          // Transactions
          loadTransactions();
        } catch (error) {
          console.error("Error loading payments:", error);
        }
      }

      async function loadTransactions() {
        try {
          // Get all transactions for this customer
          const response = await fetch(
            `${API_BASE}/transactions/${currentCustomerId}`
          );
          const transactions = (await response.ok) ? await response.json() : [];

          const tbody = document.getElementById("transactionsBody");
          tbody.innerHTML = transactions
            .map(
              (trans) => `
                    <tr>
                        <td>${formatVietnamDate(trans.created_at)}</td>
                        <td>${trans.payment_id.substring(0, 8)}</td>
                        <td>${trans.request_id.substring(0, 8)}</td>
                        <td style="font-weight: bold; color: #667eea;">${(
                          trans.amount / 1000
                        ).toFixed(0)}K ‚Ç´</td>
                        <td><span class="badge badge-paid">${translateStatus(
                          trans.status
                        )}</span></td>
                    </tr>
                `
            )
            .join("");

          if (transactions.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">Ch∆∞a c√≥ giao d·ªãch n√†o</td></tr>';
          }
        } catch (error) {
          console.error("Error loading transactions:", error);
        }
      }

        async function openPaymentModal(requestId) {
            try {
                // Fetch request ƒë·ªÉ l·∫•y gi√° ti·ªÅn
                const requestResponse = await fetch(`${API_BASE}/requests/${requestId}`);
                if (!requestResponse.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng');
                
                const request = await requestResponse.json();
                
                // Ki·ªÉm tra ƒë∆°n c√≥ b·ªã h·ªßy kh√¥ng
                if (isRequestCancelled(request)) {
                    alert('‚ö†Ô∏è ƒê∆°n h√†ng n√†y ƒë√£ b·ªã h·ªßy n√™n kh√¥ng c·∫ßn thanh to√°n.');
                    return;
                }
                
                // Ki·ªÉm tra ƒë∆°n ƒë√£ thanh to√°n ch∆∞a
                if (isRequestPaid(request)) {
                    alert('‚úÖ ƒê∆°n h√†ng n√†y ƒë√£ ƒë∆∞·ª£c thanh to√°n r·ªìi.');
                    return;
                }
                
                const paymentAmount = extractStudioPrice(request);
                
                // Redirect sang trang thanh to√°n trong c√πng frontend
                const paymentServiceUrl = window.location.origin + '/payment.html';
                const params = new URLSearchParams({
                    orderId: requestId,
                    customerId: currentCustomerId,
                    amount: paymentAmount.toString()
                });
                
                // M·ªü c·ª≠a s·ªï m·ªõi ho·∫∑c redirect
                window.open(`${paymentServiceUrl}?${params.toString()}`, '_blank', 'width=800,height=900');
            } catch (error) {
                console.error('Error opening payment page:', error);
                alert('L·ªói: ' + error.message);
            }
        }
        
        async function handlePaymentMethodChange(requestId) {
            const method = document.getElementById('paymentMethod').value;
            const qrSection = document.getElementById('qrCodeSection');
            
            if (method === 'bank_transfer') {
                qrSection.style.display = 'block';
                await loadQRCode(requestId);
            } else {
                qrSection.style.display = 'none';
            }
        }
        
        async function loadQRCode(requestId) {
            try {
                // Get amount from stored request or default
                const amount = window.currentPaymentAmount || 50000;
                const response = await fetch(`${API_BASE}/payments/qr/${requestId}?amount=${amount}`);
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫°o m√£ QR');
                
                const qrData = await response.json();
                
                // Hi·ªÉn th·ªã QR code
                document.getElementById('qrCodeImage').src = qrData.qr_code;
                
                // Hi·ªÉn th·ªã th√¥ng tin ng√¢n h√†ng
                document.getElementById('bankAccountInfo').innerHTML = `
                    <div><strong>S·ªë t√†i kho·∫£n:</strong> ${qrData.bank_account}</div>
                    <div><strong>Ng√¢n h√†ng:</strong> ${qrData.bank_name}</div>
                    <div><strong>N·ªôi dung:</strong> ${qrData.content}</div>
                `;
        } catch (error) {
          console.error("Error loading QR code:", error);
          document.getElementById("qrCodeSection").innerHTML = `
                    <div style="padding: 20px; background: #ffe0e0; border-radius: 8px; color: #c92a2a;">
                        ‚ùå Kh√¥ng th·ªÉ t·∫°o m√£ QR. Vui l√≤ng th·ª≠ l·∫°i.
                    </div>
                `;
        }
      }

      async function processPayment(event, requestId) {
        event.preventDefault();
        const method = document.getElementById("paymentMethod").value;
        const payer = document.getElementById("payerName").value.trim();

        if (!method) {
          alert("Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n");
          return;
        }

        try {
            // Get amount from stored request or fetch it
            let amount = window.currentPaymentAmount;
            if (!amount) {
                const requestResponse = await fetch(`${API_BASE}/requests/${requestId}`);
                if (requestResponse.ok) {
                    const request = await requestResponse.json();
                    amount = extractStudioPrice(request);
                } else {
                    amount = 50000; // Fallback
                }
            }

            const response = await fetch(`${API_BASE}/payments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    customer_id: currentCustomerId,
                    service_request_id: requestId,
                    amount: amount.toString(),
                    payment_method: method
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'L·ªói x·ª≠ l√Ω thanh to√°n' }));
                throw new Error(errorData.message || errorData.detail || 'L·ªói x·ª≠ l√Ω thanh to√°n');
            }

            // ƒê·ª£i 1 gi√¢y ƒë·ªÉ backend l∆∞u xong
            await new Promise(resolve => setTimeout(resolve, 1000));

            alert('‚úì Thanh to√°n th√†nh c√¥ng!');
            closePaymentModal();
            
            // Reload t·∫•t c·∫£ d·ªØ li·ªáu t·ª´ cache break
            await loadPayments();
            await loadRequests();
            await loadDashboard();
            
            // N·∫øu l√† studio booking, reload studios ƒë·ªÉ c·∫≠p nh·∫≠t status
            const currentRequest = window.currentPaymentRequest;
            if (currentRequest && currentRequest.description && currentRequest.description.includes('[STUDIO_BOOKING]')) {
                await loadStudios();
            }
                
        } catch (error) {
            alert('L·ªói: ' + error.message);
            console.error(error);
        }
      }

      function closePaymentModal() {
        document.getElementById("paymentModal").classList.remove("active");
      }

      // ==================== FEEDBACK ====================
      async function loadFeedback() {
        try {
          // Load requests for feedback dropdown
          const requestsResponse = await fetch(
            `${API_BASE}/requests/customer/${currentCustomerId}`
          );
          const requests = (await requestsResponse.ok)
            ? await requestsResponse.json()
            : [];

          const feedbackSelect = document.getElementById("feedbackRequestId");
          feedbackSelect.innerHTML =
            '<option value="">-- Ch·ªçn ƒê∆°n H√†ng --</option>' +
            requests
              .map(
                (req) =>
                  `<option value="${req.id}">${
                    req.service_type
                  } - ${req.id.substring(0, 8)} (${translateStatus(
                    req.status
                  )})</option>`
              )
              .join("");

          // Load feedback history
          const feedbackResponse = await fetch(
            `${API_BASE}/feedback/customer/${currentCustomerId}`
          );
          const feedbacks = (await feedbackResponse.ok)
            ? await feedbackResponse.json()
            : [];

          const feedbackHistory = document.getElementById("feedbackHistory");
          if (feedbacks.length === 0) {
            feedbackHistory.innerHTML =
              '<p style="text-align: center; color: #999; padding: 20px;">Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o</p>';
            return;
          }

          feedbackHistory.innerHTML = feedbacks
            .map(
              (fb) => `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${
                                  fb.feedback_type === "revision"
                                    ? "‚úèÔ∏è Y√™u C·∫ßu Ch·ªânh S·ª≠a"
                                    : fb.feedback_type === "bug"
                                    ? "üêõ B√°o L·ªói"
                                    : "üí° ƒê·ªÅ Xu·∫•t"
                                }</div>
                                <div class="card-meta">
                                    <span>ƒê∆°n: ${fb.request_id.substring(
                                      0,
                                      8
                                    )}</span>
                                    <span>${formatVietnamDate(fb.created_date)}</span>
                                </div>
                            </div>
                        </div>
                        <p style="margin: 0; color: #666; line-height: 1.6;">${
                          fb.content
                        }</p>
                    </div>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error loading feedback:", error);
        }
      }

      async function submitFeedback() {
        const requestId = document.getElementById("feedbackRequestId").value;
        const content = document.getElementById("feedbackContent").value.trim();
        const type = document.getElementById("feedbackType").value;
        const messageDiv = document.getElementById("feedbackMessage");

        if (!requestId || !content || !type) {
          showMessage(messageDiv, "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin", "error");
          return;
        }

        try {
          const formData = new FormData();
          formData.append("request_id", requestId);
          formData.append("content", content);
          formData.append("feedback_type", type);

          const response = await fetch(`${API_BASE}/feedback`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) throw new Error("L·ªói g·ª≠i ph·∫£n h·ªìi");

          showMessage(
            messageDiv,
            "‚úì Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng",
            "success"
          );
          document.getElementById("feedbackRequestId").value = "";
          document.getElementById("feedbackContent").value = "";
          document.getElementById("feedbackType").value = "";

          setTimeout(() => loadFeedback(), 2000);
        } catch (error) {
          showMessage(messageDiv, "L·ªói: " + error.message, "error");
        }
      }

        // ==================== STUDIO BOOKING ====================
        let selectedStudio = null;

        async function loadStudios() {
            try {
                const response = await fetch(`${API_BASE}/studios`);
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch studio');
                
                const result = await response.json();
                const studios = result.data || [];
                const container = document.getElementById('studiosList');
                
                if (studios.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Ch∆∞a c√≥ studio n√†o</p>';
                    return;
                }

                container.innerHTML = studios.map(studio => {
                    try {
                        // Convert status: c√≥ th·ªÉ l√† s·ªë (0,1,2) ho·∫∑c string ("Available", "Occupied", "UnderMaintenance")
                        let statusNum = studio.status;
                        if (typeof studio.status === 'string') {
                            const statusMap = {
                                'Available': 0,
                                'Occupied': 1,
                                'UnderMaintenance': 2,
                                'available': 0,
                                'occupied': 1,
                                'underMaintenance': 2
                            };
                            statusNum = statusMap[studio.status] ?? 0;
                        }
                        
                        // Ensure statusNum is a number
                        statusNum = Number(statusNum);
                        if (isNaN(statusNum)) statusNum = 0;
                        
                        const statusText = ['C√≤n ch·ªó', 'ƒê√£ c√≥ ng∆∞·ªùi ƒë·∫∑t', 'Ch∆∞a ƒë·∫∑t'][statusNum] || 'Kh√¥ng x√°c ƒë·ªãnh';
                        const statusClass = statusNum === 0 ? 'available' : statusNum === 1 ? 'occupied' : 'maintenance';
                        const isAvailable = statusNum === 0;
                        
                        // Ensure price is a number
                        const studioPrice = Number(studio.price) || 0;
                        
                        console.log('Rendering studio:', studio.id, 'status:', studio.status, 'statusNum:', statusNum, 'isAvailable:', isAvailable);
                    
                    return `
                        <div class="card" style="border: 2px solid ${isAvailable ? '#2f9e44' : '#c92a2a'};">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">${studio.name}</div>
                                    <div class="card-meta">
                                        <span>üìç ${studio.location}</span>
                                    </div>
                                </div>
                                <span class="badge badge-${statusClass}">${statusText}</span>
                            </div>
                            ${studio.image ? `<img src="${studio.image}" alt="${studio.name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin: 10px 0;">` : ''}
                            <div style="padding: 10px 0;">
                                <p style="font-size: 18px; font-weight: 600; color: #667eea; margin: 10px 0;">
                                    ${new Intl.NumberFormat('vi-VN').format(studioPrice)} VNƒê
                                </p>
                                <button 
                                    class="btn btn-primary" 
                                    onclick="openBookingModal(${studio.id}); return false;"
                                    ${!isAvailable ? 'disabled' : ''}
                                    style="width: 100%; margin-top: 10px;${!isAvailable ? ' opacity: 0.5; cursor: not-allowed;' : ''}"
                                    type="button">
                                    ${isAvailable ? 'üìÖ ƒê·∫∑t Ngay' : '‚ùå Kh√¥ng Kh·∫£ D·ª•ng'}
                                </button>
                            </div>
                        </div>
                    `;
                    } catch (e) {
                        console.error('Error rendering studio:', studio, e);
                        return `<div class="card"><p>L·ªói hi·ªÉn th·ªã studio: ${e.message}</p></div>`;
                    }
                }).join('');
            } catch (error) {
                console.error('Error loading studios:', error);
                const messageDiv = document.getElementById('studiosMessage');
                showMessage(messageDiv, 'L·ªói: ' + error.message, 'error');
            }
        }

        async function openBookingModal(studioId) {
            console.log('openBookingModal called with studioId:', studioId);
            try {
                // Get studio details
                const response = await fetch(`${API_BASE}/studios/${studioId}`);
                if (!response.ok) {
                    console.error('Failed to fetch studio:', response.status, response.statusText);
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin studio');
                }
                
                const result = await response.json();
                console.log('Studio data received:', result);
                const studio = result.data;
                
                if (!studio) {
                    alert('Kh√¥ng t√¨m th·∫•y studio');
                    return;
                }

                selectedStudio = studio;

                // Check if studio is available
                // Convert status: c√≥ th·ªÉ l√† s·ªë (0,1,2) ho·∫∑c string ("Available", "Occupied", "UnderMaintenance")
                let statusNum = studio.status;
                if (typeof studio.status === 'string') {
                    const statusMap = {
                        'Available': 0,
                        'Occupied': 1,
                        'UnderMaintenance': 2,
                        'available': 0,
                        'occupied': 1,
                        'underMaintenance': 2
                    };
                    statusNum = statusMap[studio.status] ?? 0;
                }
                statusNum = Number(statusNum) || 0;
                
                console.log('Studio status:', studio.status, 'converted to:', statusNum);
                
                if (statusNum !== 0) {
                    alert('Studio n√†y hi·ªán kh√¥ng kh·∫£ d·ª•ng (Status: ' + statusNum + ')');
                    return;
                }

                // Create booking form
                const modalBody = document.getElementById('bookingModalBody');
                modalBody.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">${studio.name}</h3>
                        <p style="color: #666; margin-bottom: 5px;">üìç ${studio.location}</p>
                        <p style="color: #667eea; font-weight: 600; font-size: 18px;">
                            Gi√°: ${new Intl.NumberFormat('vi-VN').format(studio.price)} VNƒê
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label>Ng√†y ƒê·∫∑t *</label>
                        <input type="date" id="bookingDate" required min="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="form-group">
                        <label>Gi·ªù ƒê·∫∑t *</label>
                        <select id="bookingTime" required>
                            <option value="">-- Ch·ªçn Gi·ªù --</option>
                            <option value="08:00">08:00 - 10:00</option>
                            <option value="10:00">10:00 - 12:00</option>
                            <option value="13:00">13:00 - 15:00</option>
                            <option value="15:00">15:00 - 17:00</option>
                            <option value="18:00">18:00 - 20:00</option>
                            <option value="20:00">20:00 - 22:00</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Ghi Ch√∫</label>
                        <textarea id="bookingNotes" placeholder="Ghi ch√∫ th√™m v·ªÅ y√™u c·∫ßu c·ªßa b·∫°n..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="bookStudio()" style="flex: 1;">
                            ‚úÖ X√°c Nh·∫≠n ƒê·∫∑t Studio
                        </button>
                        <button class="btn btn-secondary" onclick="closeBookingModal()" style="flex: 1;">
                            ‚ùå H·ªßy
                        </button>
                    </div>
                `;

                document.getElementById('bookingModal').classList.add('active');
            } catch (error) {
                console.error('Error opening booking modal:', error);
                alert('L·ªói: ' + error.message);
            }
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.remove('active');
            selectedStudio = null;
        }

        async function bookStudio() {
            if (!selectedStudio) {
                alert('Vui l√≤ng ch·ªçn studio');
                return;
            }

            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;
            const notes = document.getElementById('bookingNotes').value.trim();
            const messageDiv = document.getElementById('studiosMessage');

            if (!date || !time) {
                showMessage(messageDiv, 'Vui l√≤ng ch·ªçn ng√†y v√† gi·ªù ƒë·∫∑t', 'error');
                return;
            }

            try {
                // Create service request with studio booking information
                // Format: service_type = "recording" (v√¨ ƒë√¢y l√† thu √¢m studio)
                // Description s·∫Ω ch·ª©a th√¥ng tin studio booking
                const formData = new FormData();
                formData.append('customer_id', currentCustomerId);
                formData.append('service_type', 'recording'); // Studio booking l√† recording service
                formData.append('title', `ƒê·∫∑t Studio: ${selectedStudio.name}`);
                
                // T·∫°o description v·ªõi th√¥ng tin studio booking
                const bookingInfo = {
                    studio_id: selectedStudio.id,
                    studio_name: selectedStudio.name,
                    studio_location: selectedStudio.location,
                    booking_date: date,
                    booking_time: time,
                    notes: notes || '',
                    price: selectedStudio.price,
                    booking_timestamp: new Date().toISOString() // L∆∞u th·ªùi gian ƒë·∫∑t ƒë·ªÉ check timeout
                };
                formData.append('description', `ƒê·∫∑t ph√≤ng thu √¢m\nStudio: ${selectedStudio.name}\nƒê·ªãa ƒëi·ªÉm: ${selectedStudio.location}\nNg√†y: ${date}\nGi·ªù: ${time}\nGhi ch√∫: ${notes}\nGi√°: ${selectedStudio.price} VNƒê\n\n[STUDIO_BOOKING]${JSON.stringify(bookingInfo)}[/STUDIO_BOOKING]`);
                
                // Set due date to booking date
                const bookingDateTime = new Date(`${date}T${time}`);
                formData.append('due_date', bookingDateTime.toISOString());

                showMessage(messageDiv, '<div class="loading"><div class="spinner"></div> ƒêang x·ª≠ l√Ω ƒë·∫∑t studio...</div>', 'info');
                
                // Update studio status t·ª´ Available (0) -> UnderMaintenance (2) khi ƒë·∫∑t
                try {
                    const updateResponse = await fetch(`${API_BASE}/studios/${selectedStudio.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: selectedStudio.name,
                            location: selectedStudio.location,
                            price: selectedStudio.price,
                            status: 2, // UnderMaintenance (Ch∆∞a ƒë·∫∑t)
                            image: selectedStudio.image
                        })
                    });
                    if (updateResponse.ok) {
                        console.log('Studio status updated to UnderMaintenance (2)');
                    }
                } catch (e) {
                    console.error('Error updating studio status:', e);
                }

                const response = await fetch(`${API_BASE}/requests`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || errorData.message || 'L·ªói ƒë·∫∑t studio');
                }

                const request = await response.json();
                showMessage(messageDiv, `‚úì ƒê·∫∑t studio th√†nh c√¥ng! M√£ ƒë∆°n: ${request.id?.substring(0, 8) || request.id}`, 'success');
                
                // Close modal
                closeBookingModal();
                
                // Reload studios and dashboard
                setTimeout(() => {
                    loadStudios();
                    loadDashboard();
                    loadRequests();
                }, 2000);
            } catch (error) {
                console.error('Error booking studio:', error);
                showMessage(messageDiv, 'L·ªói: ' + error.message, 'error');
            }
        }

        async function loadFeedbackHistory() {
            try {
                // Feedback history is now loaded in loadFeedback()
                return;
            } catch (error) {
                console.error('Error loading feedback history:', error);
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        // Helper function to check if request is paid
        function isRequestPaid(request) {
            if (!request) return false;
            const paid = request.paid || request.Paid;
            return paid === true || paid === 'true' || paid === 1 || paid === '1';
        }
        
        // Helper function to check if request is cancelled
        function isRequestCancelled(request) {
            if (!request) return false;
            const status = (request.status || request.Status || '').toLowerCase();
            return status === 'cancelled' || 
                   status === 'canceled' || 
                   status === 'rejectedbyexpert' || 
                   status === 'rejected_by_expert' ||
                   status === 'rejectedbyadmin' ||
                   status === 'rejected_by_admin';
        }
        
        function translateStatus(status) {
            if (!status) return 'Ch∆∞a X√°c ƒê·ªãnh';
            const normalizedStatus = (status || '').toLowerCase();
            const statusMap = {
                'requested': 'üìù ƒê√£ G·ª≠i Y√™u C·∫ßu',
                'pending': '‚è≥ Ch∆∞a X·ª≠ L√Ω',
                'submitted': 'üì§ ƒê√£ G·ª≠i',
                'assigned': 'üë§ ƒê√£ Ph√¢n C√¥ng',
                'inprogress': '‚öôÔ∏è ƒêang X·ª≠ L√Ω',
                'in_progress': '‚öôÔ∏è ƒêang X·ª≠ L√Ω',
                'processing': '‚öôÔ∏è ƒêang X·ª≠ L√Ω',
                'pendingreview': 'üëÄ Ch·ªù Ch·ªçn Chuy√™n Gia',
                'pending_review': 'üëÄ Ch·ªù Ch·ªçn Chuy√™n Gia',
                'pendingmeetingconfirmation': '‚è∞ Ch·ªù Chuy√™n Gia X√°c Nh·∫≠n',
                'pending_meeting_confirmation': '‚è∞ Ch·ªù Chuy√™n Gia X√°c Nh·∫≠n',
                'completed': '‚úÖ Ho√†n Th√†nh',
                'finished': '‚úÖ Ho√†n Th√†nh',
                'rejectedbyexpert': '‚ùå Chuy√™n Gia T·ª´ Ch·ªëi',
                'rejected_by_expert': '‚ùå Chuy√™n Gia T·ª´ Ch·ªëi',
                'revisionrequested': '‚úèÔ∏è Y√™u C·∫ßu Ch·ªânh S·ª≠a',
                'revision_requested': '‚úèÔ∏è Y√™u C·∫ßu Ch·ªânh S·ª≠a',
                'cancelled': '‚ùå ƒê√£ H·ªßy',
                'canceled': '‚ùå ƒê√£ H·ªßy',
                'paid': '‚úÖ ƒê√£ Thanh To√°n',
                'unpaid': '‚ùå Ch∆∞a Thanh To√°n'
            };
            return statusMap[normalizedStatus] || status;
        }

        function getServiceIcon(serviceType) {
            const icons = {
                'transcription': 'üé§',
                'arrangement': 'üéº',
                'recording': 'üéôÔ∏è'
            };
            return icons[serviceType] || 'üìÅ';
        }

        function getProgressWidth(status) {
            if (!status) return 0;
            const normalizedStatus = (status || '').toLowerCase();
            const progress = {
                'requested': 10,
                'pending': 20,
                'submitted': 20,
                'pendingreview': 30,
                'pending_review': 30,
                'pendingmeetingconfirmation': 50,
                'pending_meeting_confirmation': 50,
                'processing': 75,
                'inprogress': 75,
                'in_progress': 75,
                'completed': 100,
                'finished': 100,
                'cancelled': 0,
                'canceled': 0,
                'rejectedbyexpert': 0,
                'rejected_by_expert': 0
            };
            return progress[normalizedStatus] || 0;
        }

        function showMessage(element, message, type) {
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        // Close payment modal when clicking outside
        document.addEventListener('click', (e) => {
            const paymentModal = document.getElementById('paymentModal');
            if (e.target === paymentModal) {            
                closePaymentModal();
            }
            
            const bookingModal = document.getElementById('bookingModal');
            if (e.target === bookingModal) {
                closeBookingModal();
            }
            
            const selectExpertModal = document.getElementById('selectExpertModal');
            if (e.target === selectExpertModal) {
                closeSelectExpertModal();
            }
        });
    </script>
  </body>
</html>
